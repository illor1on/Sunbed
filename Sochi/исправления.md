# üßæ –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç **–≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**, –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ —Ä–µ–≤–∏–∑–∏–∏ backend + frontend.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–±–æ—á–∏–π –ø–ª–∞–Ω: –ø—É–Ω–∫—Ç—ã –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å **–ø–æ –æ–¥–Ω–æ–º—É**, –≤–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ —Ä–µ–≤–∏–∑–∏–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞.

---

## üî¥ –ë–õ–û–ö–ï–†–´ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–û –õ–Æ–ë–û–ì–û –ü–†–û–î–ê–ö–®–ï–ù–ê)

### 1Ô∏è‚É£ –°–µ–∫—Ä–µ—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**
–°–µ–∫—Ä–µ—Ç—ã –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∫–æ–¥–µ (`config.py`).

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* –í—ã–Ω–µ—Å—Ç–∏ –í–°–ï —Å–µ–∫—Ä–µ—Ç—ã –≤ `.env`
* –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û `os.getenv`

**–°–ø–∏—Å–æ–∫**:

* `SECRET_KEY`
* `JWT_SECRET_KEY`
* `DB_PASSWORD`
* `YOOKASSA_SHOP_ID`
* `YOOKASSA_SECRET_KEY`
* `YOOKASSA_WEBHOOK_SECRET`
* `TTLOCK_CLIENT_ID`
* `TTLOCK_ACCESS_TOKEN`

**–ì–æ—Ç–æ–≤–æ, –∫–æ–≥–¥–∞**

* –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤
* –ï—Å—Ç—å `.env.example`

---

### 2Ô∏è‚É£ Idempotency –¥–ª—è YooKassa webhook

**–ü—Ä–æ–±–ª–µ–º–∞**
YooKassa –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ webhook –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Üí —Ä–∏—Å–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* –¢–∞–±–ª–∏—Ü–∞ `payment_events`
* –£–Ω–∏–∫–∞–ª—å–Ω—ã–π `event_id`
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π:

  ```python
  if event_id already processed:
      return 200
  ```

**–ì–æ—Ç–æ–≤–æ, –∫–æ–≥–¥–∞**

* –ü–æ–≤—Ç–æ—Ä–Ω—ã–π webhook –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

---

### 3Ô∏è‚É£ –ê—É–¥–∏—Ç –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**
–ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* –¢–∞–±–ª–∏—Ü–∞ `audit_log`
* –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å:

  * actor (user_id, role)
  * action
  * booking_id / sunbed_id
  * timestamp
  * reason (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–î–µ–π—Å—Ç–≤–∏—è**:

* `force_close`
* `remote_unlock`
* `refund_overdue`

---

## üü† –í–ê–ñ–ù–û (–ü–û–°–õ–ï –ë–õ–û–ö–ï–†–û–í)

### 4Ô∏è‚É£ –ï–¥–∏–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –≤—Ä–µ–º–µ–Ω–∏ (UTC)

**–ü—Ä–æ–±–ª–µ–º–∞**
–ï—Å—Ç—å —Ä–∏—Å–∫ —Å–º–µ—à–µ–Ω–∏—è MSK / UTC.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* Backend: —Ç–æ–ª—å–∫–æ UTC
* –ó–∞–ø—Ä–µ—Ç `naive datetime`
* Frontend: MSK —Ç–æ–ª—å–∫–æ –¥–ª—è UI

**–ì–æ—Ç–æ–≤–æ, –∫–æ–≥–¥–∞**

* –í –ë–î –Ω–µ—Ç naive –¥–∞—Ç
* –í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞—Ç—ã –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ UTC

---

### 5Ô∏è‚É£ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ force close –ø–æ —Ä–æ–ª—è–º

**–ü—Ä–æ–±–ª–µ–º–∞**
Owner –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å –∞—Ä–µ–Ω–¥—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* `force_close` ‚Üí —Ç–æ–ª—å–∫–æ `admin`
* –î–ª—è owner: `request_force_close`
* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã

---

### 6Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è webhook YooKassa

**–ü—Ä–æ–±–ª–µ–º–∞**
–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ webhook.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* –ü—Ä–æ–≤–µ—Ä–∫–∞ `YOOKASSA_WEBHOOK_SECRET`
* –û—Ç–∫–∞–∑ –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏

---

## üü° –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (–ù–ï –°–†–û–ß–ù–û)

### 7Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å—ã –ë–î

–î–æ–±–∞–≤–∏—Ç—å:

* `booking(status, end_time)`
* `booking(sunbed_id)`
* `sunbed(beach_id)`

---

### 8Ô∏è‚É£ Enum –¥–ª—è Booking.status

**–ü—Ä–æ–±–ª–µ–º–∞**
–°—Ç–∞—Ç—É—Å—ã —Å—Ç—Ä–æ–∫–∞–º–∏.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* Enum:

  * pending
  * confirmed
  * completed
  * overdue
  * cancelled

---

### 9Ô∏è‚É£ Lock events (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å**

* –¢–∞–±–ª–∏—Ü–∞ `lock_events`
* –õ–æ–≥ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ TTLock

---

## üü¢ FRONTEND (–ú–ò–ù–ò–ú–£–ú)

### üîπ 10Ô∏è‚É£ Error Boundary

**–ü—Ä–æ–±–ª–µ–º–∞**
–õ—é–±–∞—è –æ—à–∏–±–∫–∞ = –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* –ì–ª–æ–±–∞–ª—å–Ω—ã–π ErrorBoundary

---

### üîπ 11Ô∏è‚É£ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ API —Ç–∏–ø–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**
–¢–∏–ø—ã –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å**

* `shared/types.ts`
* –∏–ª–∏ OpenAPI ‚Üí TS (–ø–æ–∑–∂–µ)

---

## üß† –ò–ù–í–ê–†–ò–ê–ù–¢–´ (–ù–ï –¢–†–û–ì–ê–¢–¨)

‚ùå –ù–ï —É–ø—Ä–æ—â–∞—Ç—å:

* `lock_closed_confirmed`
* `user_requested_close`
* overdue-–ª–æ–≥–∏–∫—É

–≠—Ç–æ —è–¥—Ä–æ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üõ†Ô∏è –ü–û–†–Ø–î–û–ö –†–ê–ë–û–¢–´

1. –ë–µ—Ä—ë—Ç—Å—è **–æ–¥–∏–Ω –ø—É–Ω–∫—Ç**
2. –í–Ω–æ—Å–∏—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
3. –ö–æ–¥ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Ä–µ–≤–∏–∑–∏—é
4. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø—É–Ω–∫—Ç—É

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç:** –ø—É–Ω–∫—Ç 1 (—Å–µ–∫—Ä–µ—Ç—ã).
