–û–∫. –ù–∏–∂–µ ‚Äî **–∫–æ—Ä–æ—Ç–∫–∏–π, –∂—ë—Å—Ç–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç**, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ:

* –ø–æ–ª–æ–∂–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (`INVARIANTS.md`)
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —á–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏ –ø—Ä–∞–≤–∫–∞—Ö
* –¥–∞—Ç—å –Ω–æ–≤–æ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ë–µ–∑ –≤–æ–¥—ã.

---

# üìú INVARIANTS.md

## –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

* **Source of truth** ‚Äî –¥–∞–Ω–Ω—ã–µ –≤ –ë–î, –Ω–µ –∫—ç—à –∏ –Ω–µ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
* **Scheduler –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω**: —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –±–µ–∑ cron
* **–í—Ä–µ–º—è –≤ –ª–æ–≥–∏–∫–µ ‚Äî UTC**, –≤ –æ—Ç–≤–µ—Ç–∞—Ö –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî **MSK**
* **–ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å—ã**, –Ω–µ –∏–∑ routes/webhooks –Ω–∞–ø—Ä—è–º—É—é

---

## 1Ô∏è‚É£ Booking (–±—Ä–æ–Ω—å)

### –°–æ—Å—Ç–æ—è–Ω–∏—è

```
pending ‚Üí confirmed ‚Üí completed
          ‚Üì
       cancelled
```

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* `confirmed ‚áí payment_status == paid`
* `completed ‚áí —Ä–∞–Ω–µ–µ –±—ã–ª confirmed`
* `cancelled` –∏ `completed` ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ
* `pending` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ—Å—É—Ä—Å **—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö TTL**

### –ü—Ä–∞–≤–∏–ª–∞

* –õ—é–±–æ–π –ø–µ—Ä–µ—Ö–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏–π –±—Ä–æ–Ω–∏:

  * **–¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ `booking_service`**
* –ó–∞–ø—Ä–µ—â–µ–Ω–æ:

  * –º–µ–Ω—è—Ç—å `booking.status` –Ω–∞–ø—Ä—è–º—É—é –≤ routes/webhooks
  * –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –æ–ø–ª–∞—Ç—É –¥–ª—è –Ω–µ-`pending` –±—Ä–æ–Ω–∏

---

## 2Ô∏è‚É£ Payments / YooKassa

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* –û–¥–∏–Ω –ø–ª–∞—Ç—ë–∂ ‚Üí –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å (`booking` –∏–ª–∏ `overdue`)
* Webhook **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω**
* **Late payment ‚Üí refund**

### –ü—Ä–∞–≤–∏–ª–∞

* –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –±—Ä–æ–Ω–∏:

  ```python
  confirm_booking_payment(...)
  ```
* –í webhook:

  * –µ—Å–ª–∏ `booking.status != "pending"` ‚Üí **refund**
  * –ø–æ–≤—Ç–æ—Ä–Ω—ã–π webhook ‚Üí OK
* Webhook **–ù–ï –º–µ–Ω—è–µ—Ç** `Sunbed.status`

---

## 3Ô∏è‚É£ Pending / TTL

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* `pending` –∞–∫—Ç–∏–≤–µ–Ω **—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö TTL**
* –ü–æ—Å–ª–µ TTL:

  * –±—Ä–æ–Ω—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
  * —Ä–µ—Å—É—Ä—Å –¥–æ—Å—Ç—É–ø–µ–Ω
  * –ø–ª–∞—Ç—ë–∂ (–µ—Å–ª–∏ –ø—Ä–∏–¥—ë—Ç –ø–æ–∑–∂–µ) ‚Üí refund

### –ü—Ä–∞–≤–∏–ª–∞

* TTL –ª–æ–≥–∏–∫–∞:

  * –µ–¥–∏–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
  * availability **–Ω–µ –∑–∞–≤–∏—Å–∏—Ç** –æ—Ç cleanup
* `booking_cleanup` ‚Äî –≤—Ç–æ—Ä–∏—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º

---

## 4Ô∏è‚É£ Sunbed (–ª–µ–∂–∞–∫)

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* **Source of truth –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ ‚Äî `Booking`**
* `Sunbed.status` ‚Äî –∫—ç—à / –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

### –ü—Ä–∞–≤–∏–ª–∞

* –ó–∞–ø—Ä–µ—â–µ–Ω–æ:

  * –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Sunbed.status` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  * —Å—Ç–∞–≤–∏—Ç—å `status = "booked"` —á–µ—Ä–µ–∑ API
* –†–∞–∑—Ä–µ—à–µ–Ω–æ:

  * –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å `available` –ø—Ä–∏ `completed` (–∫–∞–∫ –∫—ç—à)

---

## 5Ô∏è‚É£ Access Code / TTLock

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* Access code —Å—É—â–µ—Å—Ç–≤—É–µ—Ç **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏**:

  * `booking.status == confirmed`
  * `payment_status == paid`
  * —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è ‚àà `[start_time, end_time]`
* –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö:

  * –¥–æ—Å—Ç—É–ø **–æ–±—è–∑–∞–Ω –±—ã—Ç—å —É–¥–∞–ª—ë–Ω**

### –ü—Ä–∞–≤–∏–ª–∞

* –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞:

  * —á–µ—Ä–µ–∑ `clear_access()`
  * —Ñ—É–Ω–∫—Ü–∏—è **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞**
* `clear_access()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏:

  * `completed`
  * `cancelled`
  * TTL cleanup
  * late payment ‚Üí refund
* Scheduler ‚Äî **–Ω–µ –≥–∞—Ä–∞–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
* `get_access_code` ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è –ª–∏–Ω–∏—è –æ–±–æ—Ä–æ–Ω—ã

---

## 6Ô∏è‚É£ Overdue / Refund

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* Overdue –Ω–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –¥–≤–∞–∂–¥—ã
* Refund –Ω–µ–ª—å–∑—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ

### –ü—Ä–∞–≤–∏–ª–∞

* –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `payment_status`
* –ß—ë—Ç–∫–∞—è —Å–≤—è–∑–∫–∞ –ø–æ `payment_id`

---

## 7Ô∏è‚É£ Time / Timezone

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* –í—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî **UTC (tz-aware)**
* –û—Ç–≤–µ—Ç—ã –¥–ª—è UI ‚Äî **MSK**

### –ü—Ä–∞–≤–∏–ª–∞

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

  ```python
  now_utc()
  to_msk()
  ```
* –ó–∞–ø—Ä–µ—â–µ–Ω–æ:

  ```python
  datetime.utcnow()
  ```

---

## 8Ô∏è‚É£ RBAC / Admin

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* Owner –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã
* Admin –º–æ–∂–µ—Ç –≤—Å—ë, –Ω–æ **—á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å—ã**

### –ü—Ä–∞–≤–∏–ª–∞

* `force-close`:

  * —á–µ—Ä–µ–∑ `try_complete_booking(force=True)`
  * –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

---

## 9Ô∏è‚É£ –ú–æ–¥–µ–ª–∏ / Serialization

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

* –ú–æ–¥–µ–ª–∏ **–Ω–µ –∑–Ω–∞—é—Ç**, –∫–∞–∫ –∏—Ö –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –ü—Ä–∞–≤–∏–ª–∞

* `to_dict()`:

  * –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç UTC
  * **–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ public API**
* –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –≤ routes

---

## üîö –ò—Ç–æ–≥

–ï—Å–ª–∏ **–≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã—à–µ —Å–æ–±–ª—é–¥–µ–Ω—ã**:

* –¥–µ–Ω—å–≥–∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
* –¥–æ—Å—Ç—É–ø –Ω–µ ‚Äú–∑–∞–≤–∏—Å–∞–µ—Ç‚Äù
* race-condition –ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç—Å—è
* cron –º–æ–∂–Ω–æ —É—Ä–æ–Ω–∏—Ç—å –±–µ–∑ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã

> **–ù–∞—Ä—É—à–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞ = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–∏–Ω—Ü–∏–¥–µ–Ω—Ç.**

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –º–æ–≥—É:

* —Å–¥–µ–ª–∞—Ç—å **–≤–µ—Ä—Å–∏—é –Ω–∞ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—É (cheat-sheet)**
* –∏–ª–∏ –ø–æ–º–æ—á—å **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ (assert / tests)**
